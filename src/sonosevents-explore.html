<!-- Sonos Events Explore Node -->
<!-- Registering Node (JavaScript) -->
<script type="text/javascript">
  RED.nodes.registerType('sonosevents-explore', {
    category: 'sonosevents',
    defaults: {
      confignode: {
        value: 'household',
        type: 'sonosevents-config'
      },
      playerHostname: { 
        value: '',
        required: true
      },
      events: {
        value:[{eventName:"avtransport\raw"}]
      },
      outputs: { 
        value: 2
      }
    },
    outputLabels: function(index) {
      return String(index)
      },
    inputs: 0, // set the number of inputs - only 0 or 1
    icon: 'sonos.png', // saved in icons/myicon.png
    color: '#F87217',
    paletteLabel: 'explore events',
    label: function() {
      return 'explore events'
    },
    oneditprepare: function() {      
      
      // enter player name or do a discovery
      try {
        $('#node-input-playerHostname').autocomplete('destroy')
      } catch (err) {}
      
      $('#node-lookup-playerHostname').click(function() {
        $('#node-lookup-playerHostname-icon').removeClass('fa-search')
        $('#node-lookup-playerHostname-icon').addClass('spinner')
        $('#node-input-playerHostname').addClass('disabled')
        $.getJSON('nrcse/discoverPlayers', function(sonosPlayer) {
          $('#node-lookup-playerHostname-icon').addClass('fa-search')
          $('#node-lookup-playerHostname-icon').removeClass('spinner')
          $('#node-lookup-playerHostname').removeClass('disabled')
          var dataArray = [];
          $.each(sonosPlayer, function(i, element) {
            dataArray.push(element)
          });
          $('#node-input-playerHostname')
            .autocomplete({
              source: dataArray,
              minLength: 0,
              close: function(event, ui) {
                $('#node-input-playerHostname').autocomplete('destroy')
              }
            })
            .autocomplete('search', '')
        })
      })
  
      // event container
      const eventNameList = [
        {name:"avtransport-raw"},
        {name:"avtransport-basics"},
        {name:"avtransport-playing"},
        {name:"avtransport-content"}
      ]

      // -- set the basics
      $("#node-input-events-container").css('min-height','250px').css('min-width','250px').editableList({
        header: $("<div>").append($.parseHTML("<div>Eventname - order defines outputs</div>")),
        sortable: true,
        removable: true, 
        addButton: "add",
        addItem: function(container, index, data) {
          if (data.eventName) {
            val = data.eventName
          } else {
            val = 'raw' // default event
          }
          let row = $('<div/>').appendTo(container);
          let selectField = $('<select/>').appendTo(row);
          for (let index = 0; index < eventNameList.length; index++) {
            selectField.append(`<option value="${eventNameList[index].name}">${eventNameList[index].name}</option>`);
          }
        }
      })

      // -- populate at beginning
      for (let i = 0; i < this.events.length; i++) {
        let event = this.events[i];
        $("#node-input-events-container").editableList('addItem',event)
      }

    }, 

    oneditsave: function() {
      // save event container
     
      let node = this
      node.outputs = $("#node-input-events-container").editableList('length');
      let newEvents = $("#node-input-events-container").editableList('items')
      node.events = []
      newEvents.each((item) =>  {
             console.log('item >>'+ JSON.stringify(item))
            // events.push(item)
      })
    },

    oneditcancel: function() {
     // currently nothing
    }
  })
</script>

<!-- Setting design and inputs for node panel (HTML)-->
<script type="text/html" data-template-name="sonosevents-explore">
  <style>
    label.event-checkbox {
        display: block !important;
        width: auto !important;
    }
    label.event-checkbox input {
        width: auto !important;
        margin-top: -3px !important;
    }
  </style>
  
  <div id="main-props">
    <!-- Config node -->
    <div class="form-row">
      <label for="node-input-confignode" style="width: 25%;"><i class="fa fa-gear" ></i> Config node</label>
      <input type="text" id="node-input-confignode" style="width: auto;">
    </div>
    <div class="form-tips" id="node-tip-confignode"  style="width: auto;">
      Config node:  There should only be one config node per household to define the internal web server. 
     </div><br>

    <!-- SONOS player hostname such such 192.168.178.37-->
    <div class="form-row">
      <label for="node-input-playerHostname" style="width: 25%;"><i class="fa fa-volume-up"></i> Player </label>
      <input type="text" id="node-input-playerHostname"  placeholder="192.168.x.x" style="width: 60%;">
      <button type="button" id="node-lookup-playerHostname" class="red-ui-button"><i id="node-lookup-playerHostname-icon" class="fa fa-search"></i></button>
    </div>
    <div class="form-tips">
      Player:  Use the search button to discover SONOS player in your local network and select a COORDINATOR.
    </div><br>

    <!-- Events-->
    <div class="form-row node-input-events-container-row">
      <ol id="node-input-events-container"></ol>
   </div>

    <!-- Amount of outputs -->
    <div class="form-row">
      <input type="hidden" id="node-input-outputs" />
    </div>

    <!-- Node name -->
    <div class="form-row">
      <label for="node-input-name" style="width: 25%;"><i class="fa fa-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="This node name" />
    </div>
    <br>
    
    <!-- Dialog help -->
    Further information: See the help text.
  </div>  
  
</script>

<!-- Help text (HTML) -->
<script type="text/html" data-help-name="sonosevents-explore">
  
    
  <a href="https://github.com/hklages/node-red-contrib-sonos-plus/wiki/A.4-Events-aka-Notifications">more about Events</a>
    
</script>
